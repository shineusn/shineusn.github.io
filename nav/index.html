<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>导航</title>
  <meta name="description" content="站内独立的导航页面，静态渲染 NavSphere 内容。">
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    .navshell { display: grid; grid-template-columns: 280px 1fr; gap: 16px; }
    @media (max-width: 880px){ .navshell { grid-template-columns: 1fr; } }
    .sidebar { position: sticky; top: 72px; align-self: start; border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: var(--surface); }
    .navlist { list-style: none; padding: 0; margin: 0; }
    .navlist a { display: block; padding: 8px 10px; border-radius: 8px; color: var(--text); text-decoration: none; }
    .navlist a:hover { background: color-mix(in oklab, var(--surface), white 10%); }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .cardx { border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: var(--surface); transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease; }
    .cardx:hover { transform: translateY(-4px); border-color: color-mix(in oklab, var(--primary), var(--border) 60%); box-shadow: var(--ring); }
    .cardx h4 { margin: 0 0 6px; font-size: 16px; }
    .cardx p { margin: 0; color: var(--muted); font-size: 13px; }
    .section-title { margin: 24px 0 12px; }
    .logo { width: 20px; height: 20px; vertical-align: -4px; margin-right: 6px; }
    .hero { padding: 88px 0 32px; position: relative; isolation: isolate; }
    .hero::before { content:""; position:absolute; inset:-20% -20% auto -20%; height:300px; background: radial-gradient(60% 80% at 30% 40%, color-mix(in oklab, var(--gradient-2), transparent 30%), transparent 60%), radial-gradient(50% 70% at 70% 60%, color-mix(in oklab, var(--gradient-1), transparent 30%), transparent 60%); filter: blur(60px) saturate(120%); opacity:.22; z-index:-1; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="brand gradient-text"><a href="/" style="text-decoration:none;color:inherit;">你的名字</a></div>
      <nav class="nav">
        <a href="/">首页</a>
        <button id="themeToggle" class="button" style="margin-left:16px;">切换主题</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero reveal">
      <div class="hero-content">
        <h1>导航</h1>
        <p id="subdesc">加载站点配置…</p>
      </div>
    </section>

    <div class="navshell">
      <aside class="sidebar">
        <ul class="navlist" id="side"></ul>
      </aside>
      <section id="content" class="reveal"></section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span>© <span id="year"></span> 你的名字. 保留所有权利。</span>
    </div>
  </footer>

  <div class="progress" aria-hidden="true"><div class="progress__bar" id="progressBar"></div></div>

  <script>
    (function(){
      var y = document.getElementById('year'); if (y) y.textContent = String(new Date().getFullYear());
      var base = '../external/NavSphere';
      var encUrl = './data.enc';
      var versionUrl = './version.txt';
      var sideEl = document.getElementById('side');
      var contentEl = document.getElementById('content');
      var subdesc = document.getElementById('subdesc');

      function el(tag, attrs, children){
        var e = document.createElement(tag);
        if (attrs) Object.keys(attrs).forEach(function(k){ if (k === 'class') e.className = attrs[k]; else if (k === 'html') e.innerHTML = attrs[k]; else e.setAttribute(k, attrs[k]); });
        (children || []).forEach(function(c){ e.appendChild(c); });
        return e;
      }

      function render(nav){
        sideEl.innerHTML = '';
        contentEl.innerHTML = '';
        (nav.navigationItems || []).forEach(function(section){
          var anchor = 'sec-' + (section.id || Math.random().toString(36).slice(2));
          sideEl.appendChild(el('li', null, [ el('a', { href: '#' + anchor }, [ document.createTextNode(section.title || '未命名') ]) ]));

          var sec = el('section', { id: anchor });
          sec.appendChild(el('h2', { class: 'section-title' }, [ document.createTextNode(section.title || '') ]));

          if ((section.items || []).length){
            var grid = el('div', { class: 'cards' });
            section.items.forEach(function(item){
              if (item.enabled === false) return;
              var link = el('a', { href: item.href || '#', target: '_blank', rel: 'noopener' }, [
                el('strong', null, [ item.icon ? el('img', { src: '../external/NavSphere/public' + (item.icon.startsWith('/')? item.icon : '/' + item.icon), alt: '', class: 'logo' }) : document.createTextNode('') , document.createTextNode(item.title || '') ])
              ]);
              var p = el('p', null, [ document.createTextNode((item.description || '').replace(/\n+/g,' ')) ]);
              var card = el('div', { class: 'cardx' }, [ el('h4', null, [link]), p ]);
              grid.appendChild(card);
            });
            sec.appendChild(grid);
          }

          (section.subCategories || []).forEach(function(cat){
            var h3 = el('h3', { class: 'section-title' }, [ document.createTextNode(cat.title || '') ]);
            sec.appendChild(h3);
            var grid2 = el('div', { class: 'cards' });
            (cat.items || []).forEach(function(item){
              if (item.enabled === false) return;
              var link = el('a', { href: item.href || '#', target: '_blank', rel: 'noopener' }, [
                el('strong', null, [ item.icon ? el('img', { src: '../external/NavSphere/public' + (item.icon.startsWith('/')? item.icon : '/' + item.icon), alt: '', class: 'logo' }) : document.createTextNode('') , document.createTextNode(item.title || '') ])
              ]);
              var p = el('p', null, [ document.createTextNode((item.description || '').replace(/\n+/g,' ')) ]);
              grid2.appendChild(el('div', { class: 'cardx' }, [ el('h4', null, [link]), p ]));
            });
            sec.appendChild(grid2);
          });

          contentEl.appendChild(sec);
        });
      }

      // Crypto helpers (WebCrypto)
      function b64ToBytes(b64){ return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
      function bytesToUtf8(bytes){ return new TextDecoder().decode(bytes); }
      async function deriveKey(pw, salt, iter){
        const enc = new TextEncoder();
        const keyMat = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations: iter, hash: 'SHA-256' }, keyMat, { name:'AES-GCM', length:256 }, false, ['decrypt']);
      }
      async function decryptPayload(pass){
        const meta = await fetch(encUrl).then(r=>r.json());
        const salt = b64ToBytes(meta.salt);
        const iv = b64ToBytes(meta.iv);
        const data = b64ToBytes(meta.data);
        const ct = data.slice(0, data.length - 16);
        const tag = data.slice(data.length - 16);
        const j = new Uint8Array(ct.length + tag.length); j.set(ct,0); j.set(tag, ct.length);
        const key = await deriveKey(pass, salt, meta.iter);
        const pt = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, j);
        return JSON.parse(bytesToUtf8(new Uint8Array(pt)));
      }

      // Password caching keyed by version
      async function loadCached(){
        try {
          var ver = await fetch(versionUrl).then(r=>r.text()).then(s=>s.trim());
          var cached = localStorage.getItem('NAV_CACHE_'+ver);
          if (cached) return JSON.parse(cached);
        } catch(e){}
        return null;
      }
      async function saveCached(obj){
        try {
          var ver = await fetch(versionUrl).then(r=>r.text()).then(s=>s.trim());
          localStorage.setItem('NAV_CACHE_'+ver, JSON.stringify(obj));
        } catch(e){}
      }

      (async function init(){
        var cached = await loadCached();
        if (cached && cached.files) {
          if (cached.files.site && cached.files.site.basic && cached.files.site.basic.description && subdesc) subdesc.textContent = cached.files.site.basic.description;
          render(cached.files.navigation);
          return;
        }
        var pass = null;
        while (!pass) { pass = prompt('请输入访问口令'); if (pass===null) break; pass = pass.trim(); }
        if (!pass) { contentEl.innerHTML = '<p style="color:var(--muted)">已取消。</p>'; return; }
        try {
          var payload = await decryptPayload(pass);
          await saveCached(payload);
          if (payload.files && payload.files.site && payload.files.site.basic && payload.files.site.basic.description && subdesc) subdesc.textContent = payload.files.site.basic.description;
          render(payload.files.navigation);
        } catch (e) {
          contentEl.innerHTML = '<p style="color:var(--muted)">口令错误或数据损坏。</p>';
        }
      })();

      // 主题切换保持一致
      var root = document.documentElement;
      function applyTheme(t) { root.classList.remove('theme-light','theme-dark'); if (t==='dark') root.classList.add('theme-dark'); if (t==='light') root.classList.add('theme-light'); }
      try { var saved = localStorage.getItem('theme'); if (saved) applyTheme(saved); } catch(e){}
      var toggle = document.getElementById('themeToggle');
      if (toggle) toggle.addEventListener('click', function(){
        var cur = root.classList.contains('theme-dark') ? 'dark' : (root.classList.contains('theme-light') ? 'light' : null);
        var next = cur === 'dark' ? 'light' : 'dark';
        applyTheme(next); try { localStorage.setItem('theme', next); } catch(e){}
      });

      // 滚动进度条
      var progress = document.getElementById('progressBar');
      if (progress) {
        var updateProgress = function () {
          var st = document.documentElement.scrollTop || document.body.scrollTop;
          var sh = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          var p = sh > 0 ? (st / sh) * 100 : 0; progress.style.width = p + '%'; };
        window.addEventListener('scroll', updateProgress, { passive: true });
        window.addEventListener('resize', updateProgress); updateProgress();
      }
    })();
  </script>
</body>
</html>

